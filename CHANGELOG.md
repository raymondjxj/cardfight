# 更新日志 (Changelog)

## 2026-01-26 更新

### 🐛 Bug修复

#### 龙骧将军消失问题
- **问题描述**：龙骧将军卡牌上场时直接消失
- **原因分析**：光环系统（AuraManager）未正确集成到BattleSystem中，导致单位上场后光环效果未更新
- **解决方案**：
  - 在 `BattleSystem` 中集成 `AuraManager`
  - 在 `playUnit` 方法中调用 `updateAuras()` 更新光环效果
  - 在 `startTurn` 中也调用 `updateAuras()` 确保每回合光环正确应用
- **相关文件**：
  - `src/core/BattleSystem.js` - 添加AuraManager集成和updateAuras调用
  - `src/core/GameState.js` - 在startTurn中添加光环更新

---

### ✨ 新功能

#### 1. 抽牌机制
- **需求**：增加抽牌的机制
- **实现**：
  - 每回合开始时自动抽一张牌
  - 手牌上限为10张，超过上限不会抽牌
  - 牌库为空时触发疲劳伤害
- **相关文件**：
  - `src/core/GameState.js` - startTurn方法中已包含抽牌逻辑

#### 2. 增加AOE法术牌抽牌概率
- **需求**：增加aoe法术牌的抽牌概率
- **实现**：
  - 修改预设卡组，增加AOE法术牌数量
  - **箭雨如潮** (C013)：从0张增加到3张
  - **烈焰风暴** (C017)：从0张增加到3张
  - 现在卡组中共有6张AOE法术牌，大幅提高抽到概率
- **相关文件**：
  - `src/core/GameState.js` - initGame方法中的卡组配置

#### 3. 英雄技能系统（循环切换）
- **需求**：增加英雄技能，点击后消耗2点法力值可以增加两点护盾，回合结束后切换为为一个单位增加圣盾，然后再切换为增加两点护甲，这样循环
- **实现**：
  - **状态0（护盾）**：消耗2点法力，给英雄增加2点护盾
  - **状态1（圣盾）**：消耗2点法力，给一个友方单位增加圣盾（抵挡一次伤害）
  - **状态2（护甲）**：消耗2点法力，给一个友方单位增加2点护甲（永久+2生命上限）
  - 每回合结束后自动切换到下一个状态（循环：0→1→2→0）
  - 添加英雄技能按钮，显示当前技能状态和描述
  - 实现圣盾机制：单位拥有 `DIVINE_SHIELD` 关键词时，会完全抵挡一次伤害
- **相关文件**：
  - `src/models/Player.js` - 添加skillState属性
  - `src/core/GameState.js` - 添加updateHeroSkillState方法
  - `src/ui/InputHandler.js` - 添加onHeroSkillClick方法
  - `src/ui/Renderer.js` - 添加英雄技能按钮渲染
  - `src/core/BattleSystem.js` - 在伤害计算中处理圣盾
  - `src/data/keywords.json` - 添加DIVINE_SHIELD关键词定义
  - `index.html` - 添加英雄技能按钮
  - `src/style.css` - 添加英雄技能按钮样式

#### 4. 英雄头像和武器系统
- **需求**：
  - 英雄的头像换成中世纪骑士，类似权力游戏中琼恩雪诺的形象
  - 左边是武器格，武器牌点击后可装备到武器格
  - 装备武器后可立刻攻击对方随从或者英雄
  - 英雄的右边是英雄技能
- **实现**：
  - **英雄头像**：
    - 使用 ⚔️ 作为头像（类似琼恩雪诺的骑士形象）
    - 更新CSS样式：深色背景（#2c3e50, #34495e）、棕色边框（#8b4513）
    - 头像尺寸调整为70x70px，更突出
    - 悬停时有放大效果
  - **武器格系统**：
    - 在英雄信息区域左侧添加武器格
    - 显示装备的武器名称和属性（攻击力/耐久度）
    - 未装备时显示"空"
    - 武器卡片样式：棕色主题，悬停有放大效果
  - **武器装备逻辑**：
    - 点击武器牌后直接装备到武器格
    - 如果已有武器，会被新武器替换
    - 装备武器后，英雄的 `exhausted` 状态重置为 `false`，可以立即攻击
    - 显示提示信息："装备了XXX！可以立即攻击"
  - **布局调整**：
    - 从左到右：武器格 - 英雄头像和详情 - 英雄技能按钮
    - 使用flexbox布局，确保各元素对齐
- **相关文件**：
  - `index.html` - 重构hero-info布局，添加武器格和技能槽
  - `src/ui/Renderer.js` - 添加renderWeapon方法和武器格元素引用
  - `src/ui/InputHandler.js` - 修改onCardClick，添加武器牌点击处理
  - `src/core/BattleSystem.js` - 修改equipWeapon，装备后重置exhausted状态
  - `src/style.css` - 添加武器格、武器卡片、hero-main、hero-skill-slot等样式

---

### 📝 技术细节

#### 光环系统集成
- `AuraManager` 现在在 `BattleSystem` 构造函数中初始化
- 单位上场后自动更新所有光环效果
- 每回合开始时也会更新光环，确保buff正确应用

#### 圣盾机制
- 圣盾通过 `DIVINE_SHIELD` 关键词实现
- 在伤害计算中优先检查圣盾，完全抵挡一次伤害后移除
- 英雄和单位都可以拥有圣盾

#### 武器系统
- 武器装备后立即重置英雄的疲惫状态
- 武器显示在专门的武器格中，便于查看
- 武器属性（攻击力/耐久度）实时显示

---

### 🎨 UI/UX改进

- 英雄头像改为骑士风格，更符合游戏主题
- 武器格采用卡片式设计，视觉效果更清晰
- 英雄技能按钮显示当前状态，便于理解
- 布局优化：武器-英雄-技能从左到右排列，信息层次更清晰

---

### 📦 相关文件清单

#### 核心逻辑
- `src/core/BattleSystem.js` - 武器装备、光环系统、圣盾处理
- `src/core/GameState.js` - 抽牌、技能状态切换、光环更新
- `src/core/AuraManager.js` - 光环效果管理（已集成）

#### 数据模型
- `src/models/Player.js` - 英雄技能状态、武器属性
- `src/models/Unit.js` - 圣盾属性
- `src/data/keywords.json` - DIVINE_SHIELD关键词定义

#### UI组件
- `src/ui/Renderer.js` - 武器格渲染、英雄技能按钮更新
- `src/ui/InputHandler.js` - 武器牌点击、英雄技能点击处理

#### 界面文件
- `index.html` - 布局重构（武器格、英雄、技能）
- `src/style.css` - 武器格、英雄头像、技能按钮样式

---

### 🔄 版本信息

- **更新日期**：2026-01-26
- **版本**：v1.1.0
- **主要变更**：Bug修复、抽牌机制、英雄技能系统、武器系统、UI优化

---

## 历史更新

### 之前的更新（摘要）

#### 反击逻辑修正
- 一击必杀时，目标仍会反击
- 如果反击伤害足够高，双方会同归于尽
- 护盾可以抵挡物理和法术伤害

#### 护盾系统
- 单位可以拥有护盾（SHIELD）和法术护盾（SPELL_SHIELD）
- 护盾值会显示在单位上
- 护盾可以抵挡对应类型的伤害

#### 英雄攻击系统
- 英雄可以装备武器获得攻击力
- 英雄可以直接攻击单位和对方英雄
- 英雄攻击时有动画和特效

#### AI攻击动画
- AI攻击时显示动画和伤害数字
- 屏幕震动效果
- 游戏结束时的特效（英雄名碎裂、胜利/失败弹窗）

---

*本日志记录了所有用户提出的修改需求和对应的实现方案。*
